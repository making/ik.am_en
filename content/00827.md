---
title: Using OpenTelemetry Java Agent to Trace Legacy Servlet Applications on Tomcat
tags: ["OpenTelemetry", "Tracing", "Zipkin", "Tomcat"]
categories: ["Observability", "OpenTelemetry"]
date: 2024-11-14T02:48:26Z
updated: 2025-01-22T15:09:40Z
---

> ⚠️ This article was automatically translated by OpenAI (deepseek-r1-32b).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

Using OpenTelemetry Java Agent to Trace Legacy Servlet Applications on Tomcat.

### Starting the Tracing Backend

We use [OTLP-compatible Zipkin](https://github.com/openzipkin-contrib/zipkin-otel) as the tracing backend here.

```
docker run --name zipkin --rm -p 9411:9411 -e UI_ENABLED=true ghcr.io/openzipkin-contrib/zipkin-otel
```

Access http://localhost:9411.

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/52755ab2-920f-4de1-af87-12b7ec8148b3">

### Installing Tomcat 9

```
brew install tomcat@9
```

If using another installation method, adjust the `CATALINA_HOME` path accordingly.

### Installing Otel Java Agent

```bash
export CATALINA_HOME=/opt/homebrew/opt/tomcat@9/libexec
wget https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar -P $CATALINA_HOME/bin
```

```bash
cat <<'EOF' > $CATALINA_HOME/bin/setenv.sh
export CATALINA_OPTS="$CATALINA_OPTS -javaagent:$CATALINA_HOME/bin/opentelemetry-javaagent.jar"
export OTEL_SERVICE_NAME=legacy-app
export OTEL_TRACES_EXPORTER=otlp
export OTEL_METRICS_EXPORTER=none
export OTEL_LOGS_EXPORTER=none
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:9411
export OTEL_TRACES_SAMPLER=traceidratio
export OTEL_TRACES_SAMPLER_ARG=1.0
export OTEL_EXPORTER_OTLP_COMPRESSION=gzip
export OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
export CATALINA_OPTS="$CATALINA_OPTS -Dotel.resource.disabled.keys=process.command_args,process.executable.path,process.runtime.name,process.runtime.version,process.pid,process.runtime.description,os.type,os.description,host.arch"
EOF
```

### Downloading and Deploying Legacy App

```
wget https://archive.apache.org/dist/struts/1.3.10/struts-1.3.10-apps.zip
unzip struts-1.3.10-apps.zip

cp struts-1.3.10/apps/struts-examples-1.3.10.war $CATALINA_HOME/webapps/
```

### Starting Tomcat

```
$CATALINA_HOME/bin/startup.sh
```

Check the logs. If you see the following, it's successful:

```
$ cat  $CATALINA_HOME/logs/catalina.out 
NOTE: Picked up JDK_JAVA_OPTIONS:  --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
Java HotSpot(TM) 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
[otel.javaagent 2024-11-14 11:33:43:373 +0900] [main] INFO io.opentelemetry.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: 2.10.0
14-Nov-2024 11:33:44.222 情報 [main] org.apache.catalina.startup.VersionLoggerListener.log Server's version name:     Apache Tomcat/9.0.97
14-Nov-2024 11:33:44.225 情報 [main] org.apache.catalina.startup.VersionLoggerListener.log Server build:            Nov 6 2024 19:55:19 UTC
14-Nov-2024 11:33:44.225 情報 [main] org.apache.catalina.startup.VersionLoggerListener.log Server version number: 9.0.97.0
...
14-Nov-2024 11:33:44.390 情報 [main] org.apache.catalina.core.StandardService.startInternal Starting service [Catalina]
14-Nov-2024 11:33:44.390 情報 [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet engine: [Apache Tomcat/9.0.97]
14-Nov-2024 11:33:44.400 情報 [main] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive [/opt/homebrew/Cellar/tomcat@9/9.0.97/libexec/webapps/struts-examples-1.3.10.war]
14-Nov-2024 11:33:44.597 情報 [main] org.apache.jasper.servlet.TldScanner.scanJars At least one JAR was scanned for TLDs yet contained no TLDs. Scan was done for the following JARs: ... (see debug log for complete list)
14-Nov-2024 11:33:44.628 情報 [main] org.apache.struts.action.ActionServlet.initChain Loading chain catalog from jar:file:/opt/homebrew/Cellar/tomcat@9/9.0.97/libexec/webapps/struts-examples-1.3.10/WEB-INF/lib/struts-core-1.3.10.jar!/org/apache/struts/chain/chain-config.xml
14-Nov-2024 11:33:44.708 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/org/apache/struts/validator/validator-rules.xml'
14-Nov-2024 11:33:44.709 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/upload/validation.xml'
14-Nov-2024 11:33:44.742 警告 [main] org.apache.struts.config.impl.ModuleConfigImpl.addFormBeanConfig Overriding ActionForm of name localeForm
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/org/apache/struts/validator/validator-rules-compressed.xml'
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/validator/validation.xml'
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/validator/validation-bundles.xml'
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/validator/validation-i18nVariables.xml'
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/validator/validation-type.xml'
14-Nov-2024 11:33:44.744 情報 [main] org.apache.struts.validator.ValidatorPlugIn.initResources Loading validation rules file from '/WEB-INF/validator/validation-validwhen.xml'
14-Nov-2024 11:33:44.765 情報 [main] org.apache.catalina.startup.HostConfig.deployWAR Deployment of web application archive [/opt/homebrew/Cellar/tomcat@9/9.0.97/libexec/webapps/struts-examples-1.3.10.war] has finished in [365] ms
...
14-Nov-2024 11:33:44.869 情報 [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["http-nio-8080"]
14-Nov-2024 11:33:44.882 情報 [main] org.apache.catalina.startup.Catalina.start Server startup in [516] ms
```

Access http://localhost:8080/struts-examples-1.3.10.

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/3158749d-c44a-4be9-83f9-4c1233f4cc5e">

### Verifying Traces

Click the "Run Query" button in Zipkin. Traces should appear.

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/18a0a2a5-5532-4f3d-afe1-465c8c454ee9">

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/84ee0759-2aeb-43e4-9075-8a6becc8b107">

### Stopping Tomcat

```
$CATALINA_HOME/bin/shutdown.sh
```
