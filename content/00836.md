---
title: と
tags: ["OpenTelemetry", "Tracing", "Zipkin", "Bitnami", "Kubernetes", "Helm", "Cassandra"]
categories: ["Observability", "OpenTelemetry", "Zipkin"]
date: 2025-01-12T13:28:55Z
updated: 2025-01-22T15:06:25Z
---

> ⚠️ This article was automatically translated by OpenAI (deepseek-r1-32b).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

のセクションを明確に分け、翻訳後のテキストを適切に配置します。

さらに、Markdownのアドバイスブロック（> [!TIP]や> [!NOTE]）も翻訳しますが、その内容は正確に伝える必要があります。例えば、「OpenTelemetry ModuleはOpenTelemetry CollectorのZipkin Exporterに比べて、Resource AttributesのSpan Tagへのマッピングなどが行われます。」は「The OpenTelemetry Module, compared to the OpenTelemetry Collector's Zipkin Exporter, performs mappings such as Resource Attributes to Span Tags.」とします。

最後に、アンインストールコマンドの部分も正確に翻訳し、Markdownの構造を維持します。ユーザーが指定した通り、コードブロック内の日本語は翻訳せず、英語のコマンドをそのまま保持します。

全体を通して、技術的な用語やコマンドの正確性を保ちつつ、自然な英語の文章に変換することが重要です。また、Markdownのフォーマットを崩さないように注意し、ユーザーの要件を満たすように心掛けます。
</think>

== title ==
Adding OpenTelemetry Module to Bitnami's Zipkin Helm Chart: A Quick Note

== content ==
Using Bitnami's [Zipkin Helm Chart](https://github.com/bitnami/charts/tree/main/bitnami/zipkin) to install Zipkin in Kubernetes, this note provides configuration details for adding the [OpenTelemetry Module](https://github.com/openzipkin-contrib/zipkin-otel/tree/main/module).

At the time of writing, OTLP HTTP/Protobuf support is implemented.

> [!TIP]
> The OpenTelemetry Module, compared to the OpenTelemetry Collector's Zipkin Exporter, performs mappings such as Resource Attributes to Span Tags.

For simplicity, a `type=LoadBalancer` service is used here. Adjust to Ingress as needed. The [zipkin-module-otel](https://mvnrepository.com/artifact/io.zipkin.contrib.otel/zipkin-module-otel) artifact is downloaded as the latest version. Replace `LATEST` with a specific version if required.

```yaml
cat <<EOF > helm-values.yaml
---
service:
  type: LoadBalancer
extraEnvVars:
- name: MODULE_OPTS
  value: "-Dloader.path=/modules/otel -Dspring.profiles.active=otel"
initContainers:
- name: download-modules
  image: nicolaka/netshoot
  command: [ "sh" ]
  args:
  - -cex
  - |
    curl -sSL https://zipkin.io/quickstart.sh | bash -s io.zipkin.contrib.otel:zipkin-module-otel:LATEST:module otel.jar
    mkdir -p /modules/otel
    mv otel.jar /modules/otel/
  volumeMounts:
  - name: modules
    mountPath: /modules
- name: unjar-modules
  image: bitnami/java
  command: [ "sh" ]
  args:
  - -cex
  - |
    cd /modules/otel
    jar -xf otel.jar
    rm -f otel.jar
  volumeMounts:
  - name: modules
    mountPath: /modules
extraVolumes:
- name: modules
  emptyDir: { }
extraVolumeMounts:
- name: modules
  mountPath: /modules
---
EOF
```

Install with the following command:

```bash
helm upgrade --install -n zipkin zipkin oci://registry-1.docker.io/bitnamicharts/zipkin -f helm-values.yaml --create-namespace --wait
```

The result will look like:

```bash
$ kubectl get pod,svc,pvc -n zipkin 
NAME                          READY   STATUS    RESTARTS   AGE
pod/zipkin-7d94745468-dsg47   1/1     Running   0          15m
pod/zipkin-cassandra-0        1/1     Running   0          165m

NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                               AGE
service/zipkin                      LoadBalancer   10.96.104.206   192.168.107.200   9411:31180/TCP                        165m
service/zipkin-cassandra            ClusterIP      10.96.142.204   <none>            9042/TCP                              165m
service/zipkin-cassandra-headless   ClusterIP      None            <none>            7000/TCP,7001/TCP,7199/TCP,9042/TCP   165m

NAME                                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-zipkin-cassandra-0   Bound    pvc-21954a68-55ef-4cba-ad4d-58b751747ac5   8Gi        RWO            standard       <unset>                 165m
```

> [!NOTE]
> Verified with the following version:
> ```bash
> $ helm list -n zipkin
> NAME  	NAMESPACE	REVISION	UPDATED                             	STATUS  	CHART       	APP VERSION
> zipkin	zipkin   	1       	2025-01-12 22:05:17.002935 +0900 JST	deployed	zipkin-1.1.1	3.4.4
> ```

Test with the [sample application](https://github.com/making/demo-zipkin-otel):

```bash
git clone https://github.com/making/demo-zipkin-otel
cd demo-zipkin-otel
./mvnw clean install -DskipTests
```

Start the backend:

```bash
java -jar backend/target/backend-0.0.1-SNAPSHOT.jar --management.zipkin.tracing.endpoint=http://192.168.107.200:9411/v1/traces
```

Start the frontend:

```bash
java -jar frontend/target/frontend-0.0.1-SNAPSHOT.jar --management.zipkin.tracing.endpoint=http://192.168.107.200:9411/v1/traces
```

Access http://localhost:8080.

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/a572b5c8-a90c-444c-af51-40358c8ae510" />

Access the Zipkin UI (http://192.168.107.200:9411 in this example):

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/ac47645b-4304-4eb8-87d0-79fdc80dd066" />

Clicking "RUN QUERY" displays traces like:

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/bd6167f6-754c-4736-8cac-2c542f6e897a" />

<img width="1024" alt="image" src="https://github.com/user-attachments/assets/1134c200-2262-4877-a672-2dbf7b5639f2" />

Bitnami's Zipkin Helm Chart uses Cassandra Storage by default for trace data persistence.

To send traces from OpenTelemetry Collector to Zipkin's OTLP endpoint, add the following configuration:

```yaml
# ...
exporters:
  otlphttp/zipkin:
    endpoint: http://zipkin.zipkin.svc.cluster.local:9411
    compression: gzip
    tls:
      insecure: true
    # ...
# ...
service:
  pipelines:
    traces:
      receivers:
      - otlp
      # ...
      processors:
      # ...
      exporters:
      - otlphttp/zipkin
      # ...
# ...
```

Uninstall with:

```bash
helm uninstall -n zipkin zipkin
```
