---
title: Wrote a Brainf*ck to WebAssembly and JVM Bytecode Compiler in Java
tags: ["Java", "WebAssembly", "Brainf*ck", "Wasm Workers Server"]
categories: ["Programming", "WebAssembly", "Brainf*ck"]
date: 2023-07-02T04:20:47Z
updated: 2023-07-18T08:02:21Z
---

> âš ï¸ This article was automatically translated by OpenAI (gpt-4o).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

To study WebAssembly, I tried writing a Brainf*ck compiler.

https://github.com/making/bfc

Before reading the WebAssembly binary format, I thought it would be easier to write in the JVM bytecode format, which is also a stack machine and more familiar to me, so I implemented the conversion to JVM bytecode first.

Since I implemented it from scratch without using any libraries like [ASM](https://asm.ow2.io/), it was very easy to create a native image using GraalVM.

You can install the native binary with brew.

```
brew install making/tap/bfc
```

~For Mac, only the Intel binary is available. (Someone please build for Apple Silicon...)~ â†’ Now supports Apple Silicon

> If GraalVM is installed, you can build it with the following commands.
> 
> ```
> git clone https://github.com/making/bfc
> cd bfc
> ./mvnw package -Pnative
> install target/bfc /usr/local/bin/
> ```
>
> Alternatively, you can build it as an executable jar file.
>
> ```
> ./mvnw package
> java -jar ~/git/bfc/target/bfc-*.jar --help
> ```

### How to use bfc

First, prepare a Brainf*ck file.

```
echo '++++++++[>+++++++++<-]>.<++++[>+++++++<-]>+.<>+++++++.<>.<>+++.<++++++[>-------------<-]>-.<+++++[>+++++++++++<-]>.<++++[>++++++<-]>.<>+++.<>------.<>--------.<++++++[>-----------<-]>-.<' > hello.bf
```

`bfc` can also be used as an interpreter.

```
$ bfc hello.bf 
Hello World!
```

Compile to JVM bytecode.

```
$ bfc hello.bf -o hello.class
$ java hello
Hello World!
$ javap hello 
public class hello {
  public static void main(java.lang.String[]);
}
```

> Due to insufficient understanding of stackmap frames, the bytecode version is 50.0 (Java 1.6 equivalent)
> 
> ```
> $ file hello.class 
> hello.class: compiled Java class data, version 50.0 (Java 1.6)
> ```

Compile to WebAssembly. Supports standard input/output of WASI preview1.

```
$ bfc hello.bf -o hello.wasm
$ wasmtime hello.wasm
Hello World!
```

Additionally, it can be converted to Java, JavaScript, and WAT (WebAssembly Text Format), making it easier to understand what is being done.

```java
$ bfc hello.bf -o hello.java 
$ java hello.java
Hello World!
$ cat hello.java
```

<details>
<summary>Execution Result</summary>

```java
public class hello {

	public static void main(String[] args) {
		final int[] memory = new int[1024];
		int pointer = 0;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		pointer += 1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
		memory[pointer] += 1;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		memory[pointer] += -1;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
	}
}
```
</details>

<br>

With the `--optimize` option, the generated code is slightly optimized. It's easier to understand when viewed in Java.

```
bfc hello.bf -o hello.java --optimize
cat hello.java
```

<details>
<summary>Execution Result</summary>

```java
public class hello {

	public static void main(String[] args) {
		final int[] memory = new int[1024];
		int pointer = 0;
		memory[pointer] += 8;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 9;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 4;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 7;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += 1;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		memory[pointer] += 7;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		memory[pointer] += 3;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 6;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += -13;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 5;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 11;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 4;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += 6;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		memory[pointer] += 3;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		memory[pointer] += -6;
		System.out.print((char) memory[pointer]);
		pointer += 0;
		memory[pointer] += -8;
		System.out.print((char) memory[pointer]);
		pointer += -1;
		memory[pointer] += 6;
	while (memory[pointer] != 0) {
		pointer += 1;
		memory[pointer] += -11;
		pointer += -1;
		memory[pointer] += -1;

	}
		pointer += 1;
		memory[pointer] += -1;
		System.out.print((char) memory[pointer]);
		pointer += -1;
	}
}
```

</details>

<br>

Additionally, there are optimizations such as setting the value directly to 0 for loops like `[-]` that decrement until the current value is 0.

Some sample files are available at https://github.com/making/bfc/tree/develop/examples.

A classic example of FizzBuzz. For WASM:

```
$ curl -sL https://github.com/making/bfc/raw/develop/examples/fizzbuzz.bf | bfc - -o fizzbuzz.wasm
$ wasmtime fizzbuzz.wasm
1
2
Fizz
4
Buzz
Fizz
7
8
Fizz
Buzz
11
Fizz
13
14
FizzBuzz
16
17
Fizz
19
Buzz
Fizz
22
23
Fizz
Buzz
26
Fizz
28
29
FizzBuzz
31
32
Fizz
34
Buzz
Fizz
37
38
Fizz
Buzz
41
Fizz
43
44
FizzBuzz
46
47
Fizz
49
Buzz
Fizz
52
53
Fizz
Buzz
56
Fizz
58
59
FizzBuzz
61
62
Fizz
64
Buzz
Fizz
67
68
Fizz
Buzz
71
Fizz
73
74
FizzBuzz
76
77
Fizz
79
Buzz
Fizz
82
83
Fizz
Buzz
86
Fizz
88
89
FizzBuzz
91
92
Fizz
94
Buzz
Fizz
97
98
Fizz
Buzz
```

It works the same way with JVM bytecode.

```
$ curl -sL https://github.com/making/bfc/raw/develop/examples/fizzbuzz.bf | bfc - -o fizzbuzz.class
$ java fizzbuzz
1
2
.. (ç•¥) ..
Fizz
Buzz
```

An example of the Mandelbrot set, often used as a complex Brainf*ck example. (This does not work with [JVM bytecode](https://github.com/making/bfc/issues/6). If you are familiar with stackmap frames, please help...)

```
$ curl -sL https://github.com/making/bfc/raw/develop/examples/mandelbrot.bf | bfc - -o mandelbrot.wasm
$ time wasmtime mandelbrot.wasm 
```

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/91643dc6-2c38-4a70-9b31-9af2b8db1673">

With the `--optimize` option, the execution time was reduced by about 37%.

```
$ curl -sL https://github.com/making/bfc/raw/develop/examples/mandelbrot.bf | bfc - -o mandelbrot.wasm --optimize
$ time wasmtime mandelbrot.wasm 
```

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/f473711d-31c6-44f1-9a16-950c531a144c">

### Deploy to Wasm Workers Server

The WASM compiled by bfc supports WASI, so you can deploy code written in Brainf*ck as a Worker on [Wasm Workers Server](https://workers.wasmlabs.dev/) and expose it via HTTP ðŸ¤¯

```
mkdir app
echo '--[-->+++++<]>.+[---->+<]>+++.-[->+++<]>+.---.--[--->+<]>-.+[->+++<]>++.[->+++<]>-.[----->+<]>.[->+++++<]>.++[->++<]>.-[->+++++<]>++.+++++++..+++.[--->+<]>-----.---[->+++<]>.++++++++++.--[--->+<]>--.------.[->+++++<]>.+.++++++++++.----------.[----->++<]>-.+.+[->+++<]>++.--[--->+<]>-.+.--.+[-->+++++<]>.[----->+<]>.--------.--..----.----------.-[->+++<]>-.-.--[--->+<]>--.++++[->+++<]>.+[-->+<]>+++.--.-[--->++<]>.[----->+<]>.--
