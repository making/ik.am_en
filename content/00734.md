---
title: Monitoring Tanzu Application Platform Workloads with Datadog
tags: ["Kubernetes", "Tanzu", "TAP", "Datadog"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP"]
date: 2023-02-04T08:01:57Z
updated: 2023-02-06T06:30:08Z
---

> ⚠️ This article was automatically translated by OpenAI (gpt-4o).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

Tanzu Application Platform offers the following Datadog buildpacks:

* https://github.com/paketo-buildpacks/datadog
* https://docs.vmware.com/en/VMware-Tanzu-Buildpacks/services/tanzu-buildpacks/GUID-partner-integrations-partner-integration-buildpacks.html#datadog

These buildpacks add the Datadog Java Agent to Java applications and the Datadog Node.js Trace Agent to Node.js applications. However, simply using these buildpacks does not send actual data to Datadog. To send data to Datadog, you need to start a separate Data Agent.

The configuration looks like the following diagram.<br>
<img width="1024" alt="image" src="https://user-images.githubusercontent.com/106908/216759836-5a3c99e4-431f-4072-8ddf-256001890559.png">

In this article, we will follow the documentation below to install the Datadog Agent on Kubernetes and monitor workloads deployed on TAP.

* https://docs.datadoghq.com/containers/kubernetes/installation/?tab=helm

We will test this on the TAP 1.4 on Kind environment built in [this article](https://ik.am/entries/733). Note that we are using the Free Trial environment of Datadog.

**Table of Contents**
<!-- toc -->

### Installing the Datadog Agent

This time, we will use the Helm Chart to install the Datadog Agent. In the future, the [Datadog Operator](https://docs.datadoghq.com/containers/kubernetes/installation?tab=operator) might be recommended.

```
helm repo add datadog https://helm.datadoghq.com
helm repo update
```

Set the Helm values.yaml as follows. Change `datadog.site`, `datadog.apiKey`, and `datadog.clusterName` according to your environment.<br>
For settings required for each Kubernetes Distribution, refer to<br>
https://docs.datadoghq.com/containers/kubernetes/distributions?tab=helm <br>.

```yaml
datadog:
  site: us3.datadoghq.com
  apiKey: xxxxxx
  clusterName: kind-sandbox
  kubelet:
    host:
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    tlsVerify: false
  apm:
    portEnabled: true
  logs:
    enabled: true
  dogstatsd:
    useHostPort: true
```

Generate the manifest using the `helm template` command and deploy it with `kubectl apply`. For Multi Cluster configurations, install it on the Run cluster.

```
kubectl create ns datadog
helm template -n datadog datadog datadog/datadog -f values.yaml > datadog.yaml
kubectl apply -n datadog -f datadog.yaml
```

The Datadog Agent will be installed as a DaemonSet. Additionally, the [Datadog Cluster Agent](https://docs.datadoghq.com/containers/cluster_agent/) for monitoring the Kubernetes cluster will be installed as a Deployment.

```
$ kubectl get pod,deploy,ds -n datadog
NAME                                         READY   STATUS    RESTARTS   AGE
pod/datadog-cluster-agent-7b8c9fb77b-xpkld   1/1     Running   0          55m
pod/datadog-vk27t                            3/3     Running   0          55m

NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/datadog-cluster-agent   1/1     1            1           150m

NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/datadog   1         1         1       1            1           kubernetes.io/os=linux   150m
```

If you do not need to monitor the Kubernetes cluster, set `clusterAgent.enabled` to `false` to avoid installing the Datadog Cluster Agent.
Additionally, setting `datadog.kubeStateMetricsCore.enabled` and `datadog.collectEvents` to `false` will reduce the data sent regarding Kubernetes.

> ⚠️ If you set `clusterAgent.enabled` to `false`, the [Datadog Admission controller](https://docs.datadoghq.com/containers/cluster_agent/admission_controller/?tab=helm) will be unavailable, and you will need to manually set the environment variable `DD_AGENT_HOST` as described later.<br>
> The `admission.datadoghq.com/enabled` label will also become meaningless.

### Deploying the Workload

Now, let's deploy the workload to be monitored. The application to be deployed is https://github.com/making/rest-service.<br>
This application structures (JSONifies) logs using [ecs-logging](https://github.com/elastic/ecs-logging). Structured logs are convenient when transferring logs to Datadog, etc.<br>

Create the workload with the following command.

```
tanzu apps workload apply rest-service \
  --app rest-service \
  --git-repo https://github.com/making/rest-service \
  --git-branch main \
  --type web \
  --annotation autoscaling.knative.dev/minScale=1 \
  --label admission.datadoghq.com/enabled=true \
  --build-env BP_DATADOG_ENABLED=true \
  --env DD_SERVICE=rest-service \
  --env DD_ENV=sandbox \
  --env DD_VERSION=1.0 \
  -n demo \
  -y
```

Key points are:

* By setting `--label admission.datadoghq.com/enabled=true`, the [Datadog Admission controller](https://docs.datadoghq.com/containers/cluster_agent/admission_controller/?tab=helm) automatically sets environment variables like `DD_AGENT_HOST` on the Pod.
* By setting `--build-env BP_DATADOG_ENABLED=true`, the [datadog buildpack](https://docs.vmware.com/en/VMware-Tanzu-Buildpacks/services/tanzu-buildpacks/GUID-partner-integrations-partner-integration-buildpacks.html#datadog) automatically installs the Datadog Java Agent during container image creation by the build service.

Setting the `DD_**` environment variables is optional but makes it easier to access application information from Datadog. At the very least, it is good to set the workload name in `DD_SERVICE`. `DD_ENV` is the environment name, and `DD_VERSION` is the application version.

> ℹ️ In a Multi Cluster environment, the values set with `--env` will be used in all (Run) environments. For values that differ by environment, such as `DD_ENV`, it is better to set them via ConfigMap or Secret. The method for setting this is described later.

Check the logs with the `stern` command.

```
stern -n demo rest-service
```

During the container image build, you can confirm that the Datadog Java Agent is added with logs like the following.

```
rest-service-build-1-build-pod build Paketo Buildpack for Datadog 3.0.0
rest-service-build-1-build-pod build   https://github.com/paketo-buildpacks/datadog
rest-service-build-1-build-pod build   Datadog Java Agent 1.1.4: Contributing to layer
rest-service-build-1-build-pod build     Downloading from https://repo1.maven.org/maven2/com/datadoghq/dd-java-agent/1.1.4/dd-java-agent-1.1.4.jar
rest-service-build-1-build-pod build     Verifying checksum
rest-service-build-1-build-pod build     Copying to /layers/paketo-buildpacks_datadog/datadog-agent-java
rest-service-build-1-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.append
rest-service-build-1-build-pod build     Writing env.launch/JAVA_TOOL_OPTIONS.delim
```

In the application startup logs, you can see the environment variable `JAVA_TOOL_OPTIONS` being output, and it includes `-javaagent:/layers/paketo-buildpacks_datadog/datadog-agent-java/dd-java-agent-1.1.4.jar`. Additionally, logs starting with `[dd.trace` indicate that the Datadog Java Agent is running. The URL of the Datadog Agent that the Datadog Java Agent connects to is output as `"agent_url":"http://172.19.0.2:8126"`. `172.19.0.2` is the Node's IP.

```
rest-service-00001-deployment-78454d968b-hmb9z workload Setting Active Processor Count to 8
rest-service-00001-deployment-78454d968b-hmb9z workload Calculating JVM memory based on 11788884K available memory
rest-service-00001-deployment-78454d968b-hmb9z workload For more information on this calculation, see https://paketo.io/docs/reference/java-reference/#memory-calculator
rest-service-00001-deployment-78454d968b-hmb9z workload Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -Xmx11168701K -XX:MaxMetaspaceSize=108182K -XX:ReservedCodeCacheSize=240M -Xss1M (Total Memory: 11788884K, Thread Count: 250, Loaded Class Count: 16686, Headroom: 0%)
rest-service-00001-deployment-78454d968b-hmb9z workload Enabling Java Native Memory Tracking
rest-service-00001-deployment-78454d968b-hmb9z workload Adding 124 container CA certificates to JVM truststore
rest-service-00001-deployment-78454d968b-hmb9z workload Spring Cloud Bindings Enabled
rest-service-00001-deployment-78454d968b-hmb9z workload Picked up JAVA_TOOL_OPTIONS: -Dmanagement.endpoint.health.probes.add-additional-paths="true" -Dmanagement.health.probes.enabled="true" -Dserver.port="8080" -Dserver.shutdown.grace-period="24s" -Djava.security.properties=/layers/paketo-buildpacks_bellsoft-liberica/java-security-properties/java-security.properties -XX:+ExitOnOutOfMemoryError -javaagent:/layers/paketo-buildpacks_datadog/datadog-agent-java/dd-java-agent-1.1.4.jar -XX:ActiveProcessorCount=8 -XX:MaxDirectMemorySize=10M -Xmx11168701K -XX:MaxMetaspaceSize=108182K -XX:ReservedCodeCacheSize=240M -Xss1M -XX:+UnlockDiagnosticVMOptions -XX:NativeMemoryTracking=summary -XX:+PrintNMTStatistics -Dorg.springframework.cloud.bindings.boot.enable=true
rest-service-00001-deployment-78454d968b-hmb9z queue-proxy {"severity":"INFO","timestamp":"2023-02-03T17:21:50.2316515Z","logger":"queueproxy","caller":"sharedmain/main.go:270","message":"Starting queue-proxy","commit":"d7e9873","knative.dev/key":"demo/rest-service-00001","knative.dev/pod":"rest-service-00001-deployment-78454d968b-hmb9z"}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:51:856 +0000] [main] INFO com.datadog.appsec.AppSecSystem - AppSec is ENABLED_INACTIVE with powerwaf(libddwaf: 1.5.1) no rules loaded
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:52:220 +0000] [dd-task-scheduler] INFO datadog.trace.agent.core.StatusLogger - DATADOG TRACER CONFIGURATION {"version":"1.1.4~022e2ba179","os_name":"Linux","os_version":"5.10.104-linuxkit","architecture":"amd64","lang":"jvm","lang_version":"11.0.17","jvm_vendor":"BellSoft","jvm_version":"11.0.17+7-LTS","java_class_version":"55.0","http_nonProxyHosts":"null","http_proxyHost":"null","enabled":true,"service":"rest-service","agent_url":"http://172.19.0.2:8126","agent_error":false,"debug":false,"analytics_enabled":false,"sampling_rules":[{},{}],"priority_sampling_enabled":true,"logs_correlation_enabled":true,"profiling_enabled":false,"remote_config_enabled":true,"debugger_enabled":false,"appsec_enabled":"ENABLED_INACTIVE","telemetry_enabled":true,"dd_version":"1.0","health_checks_enabled":true,"configuration_file":"no config file present","runtime_id":"d10c232d-88f9-441f-9efa-35ea763a7e04","logging_settings":{"levelInBrackets":false,"dateTimeFormat":"'[dd.trace 'yyyy-MM-dd HH:mm:ss:SSS Z']'","logFile":"System.err","configurationFile":"simplelogger.properties","showShortLogName":false,"showDateTime":true,"showLogName":true,"showThreadName":true,"defaultLogLevel":"INFO","warnLevelString":"WARN","embedException":false},"cws_enabled":false,"cws_tls_refresh":5000}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:52:869 +0000] [dd-task-scheduler] WARN datadog.telemetry.dependency.DependencyResolverQueue - unable to detect dependency for URI file:/workspace/
rest-service-00001-deployment-78454d968b-hmb9z workload 
rest-service-00001-deployment-78454d968b-hmb9z workload   .   ____          _            __ _ _
rest-service-00001-deployment-78454d968b-hmb9z workload  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
rest-service-00001-deployment-78454d968b-hmb9z workload ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
rest-service-00001-deployment-78454d968b-hmb9z workload  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
rest-service-00001-deployment-78454d968b-hmb9z workload   '  |____| .__|_| |_|_| |_\__, | / / / /
rest-service-00001-deployment-78454d968b-hmb9z workload  =========|_|==============|___/=/_/_/_/
rest-service-00001-deployment-78454d968b-hmb9z workload  :: Spring Boot ::                (v2.7.8)
rest-service-00001-deployment-78454d968b-hmb9z workload 
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:53.382Z","log.level": "INFO","message":"Starting RestServiceApplication v0.0.1-SNAPSHOT using Java 11.0.17 on rest-service-00001-deployment-78454d968b-hmb9z with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"com.example.restservice.RestServiceApplication","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:53.390Z","log.level": "INFO","message":"No active profile set, falling back to 1 default profile: \"default\"","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"com.example.restservice.RestServiceApplication","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload [dd.trace 2023-02-03 17:21:53:868 +0000] [dd-task-scheduler] WARN datadog.telemetry.dependency.DependencyResolverQueue - unable to detect dependency for URI file:/workspace/BOOT-INF/classes/
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.267Z","log.level": "INFO","message":"Tomcat initialized with port(s): 8080 (http)","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"org.springframework.boot.web.embedded.tomcat.TomcatWebServer","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.331Z","log.level": "INFO","message":"Starting service [Tomcat]","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"org.apache.catalina.core.StandardService","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.331Z","log.level": "INFO","message":"Starting Servlet engine: [Apache Tomcat/9.0.71]","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"org.apache.catalina.core.StandardEngine","dd.service":"rest-service","dd.env":"sandbox","dd.version":"1.0"}
rest-service-00001-deployment-78454d968b-hmb9z workload {"@timestamp":"2023-02-03T17:21:55.434Z","log.level": "INFO","message":"Initializing Spring embedded WebApplicationContext","ecs.version": "1.2.0","service.name":"reset-service","event.dataset":"reset-service","process.thread.name":"main","log.logger":"org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]","dd
