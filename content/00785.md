---
title: Notes on Tracing Contour in Tanzu Application Platform with OpenTelemetry
tags: ["Kubernetes", "Tanzu", "TAP", "Grafana", "Tempo", "Tracing", "Contour", "OpenTelemetry"]
categories: ["Dev", "CaaS", "Kubernetes", "TAP", "Tracing"]
date: 2024-01-26T08:17:54Z
updated: 2024-01-26T23:11:25Z
---

Contour, which is used as the Ingress Controller for Tanzu Application Platform, has supported [Tracing](https://projectcontour.io/docs/1.27/config/tracing/) since version 1.25. Since TAP 1.7 uses Contour 1.25, you can use this feature.

Contour only supports Tracing with OpenTelemetry (OTLP). In this article, we will use [Tempo](https://grafana.com/oss/tempo/) as a Tracing backend that supports the OTLP protocol. We will also use [Grafana](https://grafana.com/oss/grafana/) as the UI for Tempo.

First, let's create the following configuration.

<img width="910" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4f102edf-2e5c-485b-a39d-d77288c3a18c">

**Table of Contents**
<!-- toc -->

### Installing Tempo

Tempo is installed with helm.

```
helm repo add grafana https://grafana.github.io/helm-charts
```

```
helm upgrade tempo \
  -n tempo \
  grafana/tempo \
  --set tempo.receivers.zipkin=null \
  --create-namespace \
  --install \
  --wait
```

Check the Pod.

```
$ kubectl get pod -n tempo
NAME      READY   STATUS    RESTARTS   AGE
tempo-0   1/1     Running   0          9s
```

### Installing Grafana

Since Tempo does not have a UI, we install Grafana as the UI. Grafana is also installed with helm.

Please change the domain name and Cluster Issuer name according to your environment.

```yaml
cat <<EOF > helm-values.yaml
---
adminUser: grafana
adminPassword: grafana
testFramework:
  enabled: false
ingress:
  enabled: true
  hosts:
  - grafana.tapv-huge-hornet.tapsandbox.com
  tls:
  - hosts:
    - grafana.tapv-huge-hornet.tapsandbox.com
    secretName: grafana-tls
  annotations:
    cert-manager.io/cluster-issuer: tap-ingress-selfsigned
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Tempo
      uid: grafana-traces
      type: tempo
      access: proxy
      orgId: 1
      url: http://tempo.tempo.svc.cluster.local:3100
      editable: true
---
EOF
```

```
helm upgrade grafana \
  -n grafana \
  grafana/grafana \
  -f helm-values.yaml \
  --create-namespace \
  --install \
  --wait
```

Check the pod and ingress.

```
$ kubectl get pod,ing -n grafana
NAME                           READY   STATUS    RESTARTS   AGE
pod/grafana-7cb85d6cfc-qp2j8   1/1     Running   0          2m36s

NAME                                CLASS    HOSTS                                     ADDRESS         PORTS     AGE
ingress.networking.k8s.io/grafana   <none>   grafana.tapv-huge-hornet.tapsandbox.com   35.238.162.93   80, 443   2m36s
```

Access the Grafana URL. Both the username and password are `grafana`.

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/fdfe8065-8d65-420f-af13-7a86387ce8c7">

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/34de8239-9dd5-4957-bb26-2bb93ba8158c">

Select the Tempo data source in Explore. There is no data yet.

<img width="1912" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/cf3848bd-7819-4d3e-8f3a-4536e3f8760b">

### Tracing Contour

Following the [Contour documentation](https://projectcontour.io/docs/1.27/config/tracing/), create the following ExtensionService resource.

```yaml
cat <<EOF > tempo-extension.yaml
---
apiVersion: projectcontour.io/v1alpha1
kind: ExtensionService
metadata:
  name: tempo
  namespace: tempo
spec:
  protocol: h2c
  services:
  - name: tempo
    port: 4317
---
EOF

kubectl apply -f tempo-extension.yaml
```

Add the following settings to `tap-values.yaml` so that the Contour config file includes the tracing settings. Here, we change Envoy's access log to JSON format and include the `traceparent` field.

```yaml
# ...
contour:
  contour:
    configFileContents:
      tracing:
        includePodDetail: true
        extensionService: tempo/tempo
        serviceName: contour
      accesslog-format: json
      json-fields:
      - "@timestamp"
      - "authority"
      -
