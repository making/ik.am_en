---
title: Notes on Installing VMware Tanzu Operations Manager 3.0 and BOSH Director on AWS
tags: ["AWS", "Cloud Foundry", "Pivotal Cloud Foundry", "Ops Manager", "TAS", "Terraform"]
categories: ["Dev", "PaaS", "CloudFoundry", "PCF"]
date: 2024-06-25T16:46:57Z
updated: 2024-06-26T04:22:25Z
---

> ⚠️ This article was automatically translated by OpenAI (gpt-4o).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

この記事ではVMware Tanzu Operations Manager (Ops Manager) をAWSにインストールをします
[次の記事](/entries/802)では、ここで構築した環境上にTanzu Application Service 6.0 (TAS) をインストールします。

この記事では初めてインストールする人向けにできるだけGUIベースで設定を行います。

**目次**
<!-- toc -->

### Preparing the AWS Environment

まずはOps Manager及びTASをインストールする下地となるAWSリソースを作成します。

作成するネットワーク構成は次の図のようになります。

<img width="1024" alt="image" src="https://www.plantuml.com/plantuml/svg/ZLAnJiCm4Dtz5QTCC0HgfvIoe38X5YOsn719JwN2CP5zfYee_quW0RTHh5eP8jrxUk_T-QqSesLVQz5WzOORWgpnfTvM6Nm9WFyXVaeuaxEBt-zIpSzx7C1InMWskkFigCnrcSji33ZtUW2KxzwiqUuXUxnxWdjask7-1sgF3TLWA4yPgfYXcb0j1bLrIhM8gHQzQYj4k5cDfllNP3XwDxa8Zl5ThmCf6bqkZqdjGH165qqmJmXmbU2_YDixiX_RYk8PbWaPRb9kC1k72BLwC4pM48Tk2T6N6dBVvBVmF6QyYF20Vvokd05cT9FpOTzfS4LcxMlz3G00">

必要なリソースは[ドキュメント](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/aws-required-objects.html)に記載されていますが、これをマニュアルで作成するのは大変なので、Terraformを使用します。

Terraform CLIのインストールは[こちら](https://www.hashicorp.com/official-packaging-guide?product_intent=terraform)を参照してください。

本記事の内容はUbuntu Jammy上で次のバージョンのCLIを使って動作確認しています。

```
$ terraform --version
Terraform v1.8.5
on linux_amd64
```

また前提条件としてRoute 53のHosted Zoneが1つ必要です。ここでは`aws.maki.lol`というHosted Zoneを例に説明します。

<img width="1001" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0b150b97-76c7-4371-bbdd-8369e6c77b73">

Terraformの[テンプレート](https://github.com/making/tas-paving-aws)を取得します。

```
git clone https://github.com/making/tas-paving-aws
cd tas-paving-aws
```

このテンプレートで

* VPC
* Subnet
* Security Group
* EIP
* NLB
* Internet Gateway
* NAT Gateway
* IAM Role
* IAM Policy
* IAM Instance Profile
* Route53 Record
* S3 Bucket

などを作成します。

以下の環境変数を設定します。

```bash
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=... (Optional)
export AWS_REGION=ap-northeast-1

export TF_VAR_availability_zones='["ap-northeast-1a","ap-northeast-1c","ap-northeast-1d"]'
export TF_VAR_environment_name=sandbox
export TF_VAR_hosted_zone=aws.maki.lol
```

> [!NOTE] `AWS_ACCESS_KEY_ID`と`AWS_SECRET_ACCESS_KEY`はTerraformの実行及び、後述のOps Manager VMの作成にのみ利用します。以降はTerraformで作成されたInstance Profileを使用してAWS APIにアクセスします。TAS自体に`AWS_ACCESS_KEY_ID`と`AWS_SECRET_ACCESS_KEY`を設定することはありません。

> [!TIP] VMWare社員は[Cloud Gate](https://console.cloudgate.vmware.com/)で発行できるPower Userの一時的なCredentialsで作業できます。

Terraformを実行します。

```
cd aws
terraform init
terraform plan -out plan
terraform apply plan
cd ..
```

AWSのConsoleで前述の図の通りのNetworkが作成されたことがわかるでしょう。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4a185adb-df6a-452c-826b-28af23c314e9">

### Installing Ops Manager

TASをインストールするために必要なOps Managerをインストールします。
次の図のようにOps Managerは`public`ネットワーク上に作成し、EIPを経由してアクセスします。

<img width="1024" alt="image" src="https://www.plantuml.com/plantuml/svg/ZPFFJeD048Vl-nGJlEXXjKjhhHTJJyQ3zkAjuJ3011jX8RkBJJMyk_nfkxIoAUcbcMyoy_5ZM6g3ofHPoWgClZ0Xy8eoJ3UH1xyCu5Z47m7NOdBR_kxysKt70MGUrtXLQ7X3MRSghoqhYWpA9AtPbaAUXbpy0rf_za2Obp96jGFl_Va3Nj3G5dSDgauz_Bs7i1x32ttNGdzWwdG_rRyqTUgQseAALOpPABCsaeoaSSOfvdQZ-raVR9DJNInEcwgUY47jD9YD4BWViN_kNgz9VMyYSZiiHZWyZibWSYvXp-fL6bAIZBqjXf795QmAKjZykKeKaMJiME3hhXHm_WJhtf47Z7MV2V2oQDZvy83PTt_eiNTTOuDwi7w8QX0kISPbblu1">

Ops ManagerのインストールをAWS Consoleから行うのは手間がかかるので、[`om`](https://github.com/pivotal-cf/om) CLIを使って、Ops Manage VMを作成します。

```
curl https://github.com/pivotal-cf/om/releases/download/7.12.0/om-linux-amd64-7.12.0 -sL -o om
chmod +x om
sudo mv om /usr/local/bin/om
```

Ops Manager VMを作成するための設定ファイルを次のように作成します。

```yaml
cat <<EOF > opsman.yml
---
opsman-configuration:
  aws:
    region: ${AWS_REGION}
    vpc_subnet_id: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_subnet_id)
    security_group_ids:
    - $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_security_group_id)
    - $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .platform_vms_security_group_id)
    key_pair_name: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_key_pair_name)
    iam_instance_profile_name: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_iam_instance_profile_name)
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    public_ip: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_public_ip)
    private_ip: 10.0.0.10
---
EOF
```

Ops ManagerのAMIイメージのIDは[Broadcom Support Portal](https://support.broadcom.com/) (BSP)から取得する必要があります。
BSPにログインして、次の図のように"Tanzu"を選択してください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/01a7b492-4ef0-4c25-9088-10c73d1e6d19">

"My Downloads"から"VMware Tanzu Operation Manager"を選択してください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/db5bb28f-8dd1-4572-abba-15ad62c6762c">

"VMware Tanzu Operation Manager"をクリックしてください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/35e534ca-a5d1-43a9-a0ba-6cebd4968efe">

最新バージョンを選択してください。下の図では`3.0.30+LTS-T`です。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/321b74aa-bc64-43fc-9b27-c1d935671763">

**"I agree to the Terms and Conditions"にチェックを入れて**、"Tanzu Ops Manager YAML for AWS ..."をダウンロードしてください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/f5d0d69c-981c-43a2-8bab-2509bdd9a9cc">

次のようなYAMLが取得できます。

```yaml
$ cat ops-manager-aws-3.0.30+LTS-T.yml 
---
ap-south-2: ami-079351fec0d47937b
# ...
ap-northeast-1: ami-00d6d7bbd9d6a202f
# ...
```

先ほど作成した`opsman.yml`とBSPからダウンロードしたYAMLを使って、次のように`om`コマンドでOps Manager VMを作成します。

```
om vm-lifecycle create-vm --config=opsman.yml --image-file=ops-manager-aws-3.0.30+LTS-T.yml
```

次のようなログが出力され、Ops Manager VMが作成されます。

```
Using aws...

Executing: "aws ec2 run-instances --tag-specifications ResourceType=instance,Tags=[{Key=Name,Value=ops-manager-vm}] --image-id ami-00d6d7bbd9d6a202f --subnet-id subnet-014057c9d1c4a7bd6 --security-group-ids sg-01e92981c8c881bec sg-0ffd0662a685d574f --count 1 --instance-type m5.large --key-name sandbox-ops-manager-key --no-associate-public-ip-address --iam-instance-profile Name=sandbox-ops-manager --query Instances[0].InstanceId --private-ip-address 10.0.0.10"
This could take a few moments...
aws[stdout]: "i-0ddbef586f5731165"

Executing: "aws ec2 describe-volumes --filters Name=attachment.instance-id,Values=i-0ddbef586f5731165 Name=attachment.status,Values=attached Name=status,Values=in-use --query Volumes[0].VolumeId"
This could take a few moments...
aws[stdout]: "vol-0a4005fe1de960ff7"

Executing: "aws ec2 modify-volume --volume-id vol-0a4005fe1de960ff7 --size 200"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "VolumeModification": {
aws[stdout]:         "VolumeId": "vol-0a4005fe1de960ff7",
aws[stdout]:         "ModificationState": "modifying",
aws[stdout]:         "TargetSize": 200,
aws[stdout]:         "TargetIops": 600,
aws[stdout]:         "TargetVolumeType": "gp2",
aws[stdout]:         "TargetMultiAttachEnabled": false,
aws[stdout]:         "OriginalSize": 10,
aws[stdout]:         "OriginalIops": 100,
aws[stdout]:         "OriginalVolumeType": "gp2",
aws[stdout]:         "OriginalMultiAttachEnabled": false,
aws[stdout]:         "Progress": 0,
aws[stdout]:         "StartTime": "2024-06-25T03:08:34+00:00"
aws[stdout]:     }
aws[stdout]: }

Executing: "aws ec2 describe-addresses --filters Name=public-ip,Values=54.65.94.27 --query Addresses[0].AllocationId"
This could take a few moments...
aws[stdout]: "eipalloc-0b56ffe4ab20a23d2"

Executing: "aws ec2 associate-address --allocation-id eipalloc-0b56ffe4ab20a23d2 --instance-id i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "AssociationId": "eipassoc-0b5a6e1c26ee8d6ec"
aws[stdout]: }

Executing: "aws ec2 stop-instances --instance-ids i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "StoppingInstances": [
aws[stdout]:         {
aws[stdout]:             "CurrentState": {
aws[stdout]:                 "Code": 64,
aws[stdout]:                 "Name": "stopping"
aws[stdout]:             },
aws[stdout]:             "InstanceId": "i-0ddbef586f5731165",
aws[stdout]:             "PreviousState": {
aws[stdout]:                 "Code": 16,
aws[stdout]:                 "Name": "running"
aws[stdout]:             }
aws[stdout]:         }
aws[stdout]:     ]
aws[stdout]: }

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

...

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopped"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 start-instances --instance-ids i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "StartingInstances": [
aws[stdout]:         {
aws[stdout]:             "CurrentState": {
aws[stdout]:                 "Code": 0,
aws[stdout]:                 "Name": "pending"
aws[stdout]:             },
aws[stdout]:             "InstanceId": "i-0ddbef586f5731165",
aws[stdout]:             "PreviousState": {
aws[stdout]:                 "Code": 80,
aws[stdout]:                 "Name": "stopped"
aws[stdout]:             }
aws[stdout]:         }
aws[stdout]:     ]
aws[stdout]: }
OpsMan VM created successfully
```

ECSのダッシュボードで`opa-manage-vm`という名前のインスタンスを確認できるでしょう。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4c184b47-8e80-4ec8-87d7-97ae1791c9e3">

このOps ManagerのDNS名は次のコマンドで確認できます。`opsmanager.${TF_VAR_environment_name}.${TF_VAR_hosted_zone}`であるはずです。

```
cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_dns
```

自己署名証明書が使用されているため、ブラウザでアクセスすると、次のような警告が表示されるでしょう。ブラウザの画面にカーソルを合わせて、`this is unsafe`と入力してください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/07880864-94b8-49c7-9a89-3bc957fd8b3b">

Ops Managerの初回セットアップ画面が表示されます。"Internal Authentication"ボタンをクリックしてください。

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/508e0163-ac4c-4223-a683-152474953789">

管理ユーザーのユーザー名とパスワード、復号パスフレーズを設定し、"Setup Authentication"ボタンをクリックしてください。

<img width="1024" alt="image
