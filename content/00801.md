---
title: Notes on Installing VMware Tanzu Operations Manager 3.0 and BOSH Director on AWS
tags: ["AWS", "Cloud Foundry", "Pivotal Cloud Foundry", "Ops Manager", "TAS", "Terraform"]
categories: ["Dev", "PaaS", "CloudFoundry", "PCF"]
date: 2024-06-25T16:46:57Z
updated: 2024-06-26T04:22:25Z
---

> ⚠️ This article was automatically translated by OpenAI (gpt-4o).
> It may be edited eventually, but please be aware that it may contain incorrect information at this time.

この記事ではVMware Tanzu Operations Manager (Ops Manager) をAWSにインストールをします
[次の記事](/entries/802)では、ここで構築した環境上にTanzu Application Service 6.0 (TAS) をインストールします。

この記事では初めてインストールする人向けにできるだけGUIベースで設定を行います。

**目次**
<!-- toc -->

### Preparing the AWS Environment

First, we will create the AWS resources that will serve as the foundation for installing Ops Manager and TAS.

The network configuration to be created will look like the following diagram.

<img width="1024" alt="image" src="https://www.plantuml.com/plantuml/svg/ZLAnJiCm4Dtz5QTCC0HgfvIoe38X5YOsn719JwN2CP5zfYee_quW0RTHh5eP8jrxUk_T-QqSesLVQz5WzOORWgpnfTvM6Nm9WFyXVaeuaxEBt-zIpSzx7C1InMWskkFigCnrcSji33ZtUW2KxzwiqUuXUxnxWdjask7-1sgF3TLWA4yPgfYXcb0j1bLrIhM8gHQzQYj4k5cDfllNP3XwDxa8Zl5ThmCf6bqkZqdjGH165qqmJmXmbU2_YDixiX_RYk8PbWaPRb9kC1k72BLwC4pM48Tk2T6N6dBVvBVmF6QyYF20Vvokd05cT9FpOTzfS4LcxMlz3G00">

The necessary resources are listed in the [documentation](https://docs.vmware.com/en/VMware-Tanzu-Operations-Manager/3.0/vmware-tanzu-ops-manager/aws-required-objects.html), but creating them manually is cumbersome, so we will use Terraform.

Refer to [this guide](https://www.hashicorp.com/official-packaging-guide?product_intent=terraform) for installing the Terraform CLI.

The content of this article has been verified to work on Ubuntu Jammy using the following version of the CLI.

```
$ terraform --version
Terraform v1.8.5
on linux_amd64
```

Additionally, as a prerequisite, you will need one Hosted Zone in Route 53. Here, we will use a Hosted Zone called `aws.maki.lol` as an example.

<img width="1001" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/0b150b97-76c7-4371-bbdd-8369e6c77b73">

Obtain the Terraform [template](https://github.com/making/tas-paving-aws).

```
git clone https://github.com/making/tas-paving-aws
cd tas-paving-aws
```

This template will create:

* VPC
* Subnet
* Security Group
* EIP
* NLB
* Internet Gateway
* NAT Gateway
* IAM Role
* IAM Policy
* IAM Instance Profile
* Route53 Record
* S3 Bucket

Set the following environment variables.

```bash
export AWS_ACCESS_KEY_ID=...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=... (Optional)
export AWS_REGION=ap-northeast-1

export TF_VAR_availability_zones='["ap-northeast-1a","ap-northeast-1c","ap-northeast-1d"]'
export TF_VAR_environment_name=sandbox
export TF_VAR_hosted_zone=aws.maki.lol
```

> [!NOTE] `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are only used for running Terraform and creating the Ops Manager VM mentioned later. After that, AWS API access will use the Instance Profile created by Terraform. TAS itself does not require setting `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`.

> [!TIP] VMware employees can use temporary Power User credentials issued by [Cloud Gate](https://console.cloudgate.vmware.com/) for this work.

Run Terraform.

```
cd aws
terraform init
terraform plan -out plan
terraform apply plan
cd ..
```

You should see the network created as shown in the previous diagram in the AWS Console.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4a185adb-df6a-452c-826b-28af23c314e9">

### Installing Ops Manager

We will install Ops Manager, which is necessary for installing TAS. As shown in the following diagram, Ops Manager will be created on the `public` network and accessed via EIP.

<img width="1024" alt="image" src="https://www.plantuml.com/plantuml/svg/ZPFFJeD048Vl-nGJlEXXjKjhhHTJJyQ3zkAjuJ3011jX8RkBJJMyk_nfkxIoAUcbcMyoy_5ZM6g3ofHPoWgClZ0Xy8eoJ3UH1xyCu5Z47m7NOdBR_kxysKt70MGUrtXLQ7X3MRSghoqhYWpA9AtPbaAUXbpy0rf_za2Obp96jGFl_Va3Nj3G5dSDgauz_Bs7i1x32ttNGdzWwdG_rRyqTUgQseAALOpPABCsaeoaSSOfvdQZ-raVR9DJNInEcwgUY47jD9YD4BWViN_kNgz9VMyYSZiiHZWyZibWSYvXp-fL6bAIZBqjXf795QmAKjZykKeKaMJiME3hhXHm_WJhtf47Z7MV2V2oQDZvy83PTt_eiNTTOuDwi7w8QX0kISPbblu1">

Installing Ops Manager from the AWS Console is cumbersome, so we will use the [`om`](https://github.com/pivotal-cf/om) CLI to create the Ops Manager VM.

```
curl https://github.com/pivotal-cf/om/releases/download/7.12.0/om-linux-amd64-7.12.0 -sL -o om
chmod +x om
sudo mv om /usr/local/bin/om
```

Create a configuration file for creating the Ops Manager VM as follows.

```yaml
cat <<EOF > opsman.yml
---
opsman-configuration:
  aws:
    region: ${AWS_REGION}
    vpc_subnet_id: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_subnet_id)
    security_group_ids:
    - $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_security_group_id)
    - $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .platform_vms_security_group_id)
    key_pair_name: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_key_pair_name)
    iam_instance_profile_name: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_iam_instance_profile_name)
    access_key_id: ${AWS_ACCESS_KEY_ID}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY}
    public_ip: $(cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_public_ip)
    private_ip: 10.0.0.10
---
EOF
```

You will need to obtain the AMI image ID for Ops Manager from the [Broadcom Support Portal](https://support.broadcom.com/) (BSP). Log in to BSP and select "Tanzu" as shown in the following diagram.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/01a7b492-4ef0-4c25-9088-10c73d1e6d19">

Select "VMware Tanzu Operation Manager" from "My Downloads".

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/db5bb28f-8dd1-4572-abba-15ad62c6762c">

Click "VMware Tanzu Operation Manager".

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/35e534ca-a5d1-43a9-a0ba-6cebd4968efe">

Select the latest version. In the diagram below, it is `3.0.30+LTS-T`.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/321b74aa-bc64-43fc-9b27-c1d935671763">

**Check "I agree to the Terms and Conditions"** and download "Tanzu Ops Manager YAML for AWS ...".

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/f5d0d69c-981c-43a2-8bab-2509bdd9a9cc">

You will obtain a YAML file like the following.

```yaml
$ cat ops-manager-aws-3.0.30+LTS-T.yml 
---
ap-south-2: ami-079351fec0d47937b
# ...
ap-northeast-1: ami-00d6d7bbd9d6a202f
# ...
```

Using the `opsman.yml` created earlier and the YAML downloaded from BSP, create the Ops Manager VM with the `om` command as follows.

```
om vm-lifecycle create-vm --config=opsman.yml --image-file=ops-manager-aws-3.0.30+LTS-T.yml
```

You will see logs like the following, and the Ops Manager VM will be created.

```
Using aws...

Executing: "aws ec2 run-instances --tag-specifications ResourceType=instance,Tags=[{Key=Name,Value=ops-manager-vm}] --image-id ami-00d6d7bbd9d6a202f --subnet-id subnet-014057c9d1c4a7bd6 --security-group-ids sg-01e92981c8c881bec sg-0ffd0662a685d574f --count 1 --instance-type m5.large --key-name sandbox-ops-manager-key --no-associate-public-ip-address --iam-instance-profile Name=sandbox-ops-manager --query Instances[0].InstanceId --private-ip-address 10.0.0.10"
This could take a few moments...
aws[stdout]: "i-0ddbef586f5731165"

Executing: "aws ec2 describe-volumes --filters Name=attachment.instance-id,Values=i-0ddbef586f5731165 Name=attachment.status,Values=attached Name=status,Values=in-use --query Volumes[0].VolumeId"
This could take a few moments...
aws[stdout]: "vol-0a4005fe1de960ff7"

Executing: "aws ec2 modify-volume --volume-id vol-0a4005fe1de960ff7 --size 200"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "VolumeModification": {
aws[stdout]:         "VolumeId": "vol-0a4005fe1de960ff7",
aws[stdout]:         "ModificationState": "modifying",
aws[stdout]:         "TargetSize": 200,
aws[stdout]:         "TargetIops": 600,
aws[stdout]:         "TargetVolumeType": "gp2",
aws[stdout]:         "TargetMultiAttachEnabled": false,
aws[stdout]:         "OriginalSize": 10,
aws[stdout]:         "OriginalIops": 100,
aws[stdout]:         "OriginalVolumeType": "gp2",
aws[stdout]:         "OriginalMultiAttachEnabled": false,
aws[stdout]:         "Progress": 0,
aws[stdout]:         "StartTime": "2024-06-25T03:08:34+00:00"
aws[stdout]:     }
aws[stdout]: }

Executing: "aws ec2 describe-addresses --filters Name=public-ip,Values=54.65.94.27 --query Addresses[0].AllocationId"
This could take a few moments...
aws[stdout]: "eipalloc-0b56ffe4ab20a23d2"

Executing: "aws ec2 associate-address --allocation-id eipalloc-0b56ffe4ab20a23d2 --instance-id i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "AssociationId": "eipassoc-0b5a6e1c26ee8d6ec"
aws[stdout]: }

Executing: "aws ec2 stop-instances --instance-ids i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "StoppingInstances": [
aws[stdout]:         {
aws[stdout]:             "CurrentState": {
aws[stdout]:                 "Code": 64,
aws[stdout]:                 "Name": "stopping"
aws[stdout]:             },
aws[stdout]:             "InstanceId": "i-0ddbef586f5731165",
aws[stdout]:             "PreviousState": {
aws[stdout]:                 "Code": 16,
aws[stdout]:                 "Name": "running"
aws[stdout]:             }
aws[stdout]:         }
aws[stdout]:     ]
aws[stdout]: }

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopping"
aws[stdout]:     ]
aws[stdout]: ]

...

Executing: "aws ec2 describe-instances --instance-ids i-0ddbef586f5731165 --query Reservations[*].Instances[*].State.Name"
This could take a few moments...
aws[stdout]: [
aws[stdout]:     [
aws[stdout]:         "stopped"
aws[stdout]:     ]
aws[stdout]: ]

Executing: "aws ec2 start-instances --instance-ids i-0ddbef586f5731165"
This could take a few moments...
aws[stdout]: {
aws[stdout]:     "StartingInstances": [
aws[stdout]:         {
aws[stdout]:             "CurrentState": {
aws[stdout]:                 "Code": 0,
aws[stdout]:                 "Name": "pending"
aws[stdout]:             },
aws[stdout]:             "InstanceId": "i-0ddbef586f5731165",
aws[stdout]:             "PreviousState": {
aws[stdout]:                 "Code": 80,
aws[stdout]:                 "Name": "stopped"
aws[stdout]:             }
aws[stdout]:         }
aws[stdout]:     ]
aws[stdout]: }
OpsMan VM created successfully
```

You should see an instance named `ops-manager-vm` on the ECS dashboard.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/4c184b47-8e80-4ec8-87d7-97ae1791c9e3">

The DNS name of this Ops Manager can be confirmed with the following command. It should be `opsmanager.${TF_VAR_environment_name}.${TF_VAR_hosted_zone}`.

```
cat tas-paving-aws/terraform.tfstate | jq .outputs.stable_config_opsmanager.value -r | jq -r .ops_manager_dns
```

Since a self-signed certificate is used, you will see a warning when accessing it via a browser. Hover over the browser screen and type `this is unsafe`.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/07880864-94b8-49c7-9a89-3bc957fd8b3b">

The initial setup screen for Ops Manager will be displayed. Click the "Internal Authentication" button.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/508e0163-ac4c-4223-a683-152474953789">

Set the username and password for the admin user, and the decryption passphrase, then click the "Setup Authentication" button.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/b9e03d7f-7836-4a2b-a9ad-a91ae18e2c61">

Please wait for a while.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/5ff5efc8-6a7e-449a-a489-259b954e2919">

The login screen will be displayed.

<img width="1024" alt="image" src="https://github.com/making/blog.ik.am/assets/106908/40bb94f4-aaec-427e-9e76-1ae7e05abc41">

Enter the username and password for the admin user you set, and click the "SIGN IN" button. The following dashboard screen will be displayed.

<img width="1024" alt="image
